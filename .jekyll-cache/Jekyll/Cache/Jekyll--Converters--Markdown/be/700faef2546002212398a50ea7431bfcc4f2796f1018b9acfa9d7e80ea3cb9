I"∑"<p>I listen to podcasts when I‚Äôm driving to and from work, and one of my favorites (mostly for the people he interviews) is the Tim Ferriss Show. He recently did a fantastic <a href="http://fourhourworkweek.com/2016/03/11/the-interview-master-cal-fussman-and-the-power-of-listening/">interview</a> with Cal Fussman, a well-seasoned writer for Esquire magazine. When asked for his advice after 35+ years of writing to someone just starting out, Cal‚Äôs advice was simple:</p>
<blockquote>
  <p>‚ÄúJust write. Write and keep writing. Don‚Äôt say ‚ÄòI need school to make me write‚Äô. You make you write‚Äù</p>
</blockquote>

<p>In the same way, let‚Äôs just Node; or as <a href="http://shoptalkshow.com/">Shoptalk Show</a> likes to say ‚Äújust. build. websites‚Äù.</p>

<h4 id="the-mission">The Mission</h4>
<p>March Madness is hot &amp; heavy right now, and although I‚Äôm not a ‚Äò4x4-driving, college-sports-loving, football-tailgating, bud-light-drinking‚Äô type of a guy, a few high school friends and I have a pool going, and we like to smack talk throughout March. So I decided to make a site that redesigned the interface to something clearer, and more March-like. No real point, but some fun relevance. Oh yeah, it‚Äôs gotta be free too.</p>

<h4 id="the-plan">The Plan</h4>
<p>Use Node to scrape ESPN‚Äôs site every ten minutes, find standings, return bracket names, user names, what percent each bracket score is, and use a database to cache calls, then update and render a site that reformats the data how I want it.</p>

<h4 id="all-the-things">All the Things</h4>
<p>Node offers tons of flexibility, which is why it‚Äôs so powerful, but getting started with all of these options can be overwhelming. After some trial and error, I found that using the skeleton express example provided by the <a href="http://expressjs.com/en/starter/generator.html">express application generator</a> is a good place to start.</p>

<p>Anything blocking in Node is a no-no. The Node replacement for this is a callback, or saying, ‚Äúwhen we‚Äôre at this point in the code, call this function‚Äù. As I mentioned earlier, callbacks are super confusing, and you can easily get yourself in spaghetti <a href="http://callbackhell.com/">trouble</a> if chaining them. A lot of people use a Node module called <a href="https://www.npmjs.com/package/q">q</a> to help manage their promises/callbacks. I was able to keep things somewhat shallow using traditional callbacks, but as you‚Äôll see, it‚Äôs a bit headache-inducing.</p>

<hr />

<h1 id="okay-lets-do-it">Okay, let‚Äôs do it</h1>
<p>Prior to this weekend, my Node experience stopped at what I needed to know to use Grunt. My server knowledge is also fairly basic, so this is by no means an expert example. Get started by pulling down the repo for this Node app <a href="https://github.com/HansEngebretsen/bracket-scraper">here</a>.</p>

<h4 id="the-structure">The Structure</h4>
<ul>
  <li>App.js   - this is our main application Javascript, it starts the party</li>
  <li>Procfile - this is what tells Heroku what to run</li>
  <li>src/     - our client side source sass &amp; js</li>
  <li>views/   - jade files &amp; template that generates our HTML and integrates data</li>
  <li>routes/  - since we‚Äôre a single page, our main route file, passes data into templates</li>
  <li>public/  - all of our generated CSS/JS and static files</li>
  <li>modules/ - functions/modules used in the Node app.</li>
</ul>

<h4 id="installing-a-new-package">Installing a new package</h4>
<p>If you haven‚Äôt yet, check out <a href="https://www.google.com/search?safe=off&amp;espv=2&amp;q=node+hello+world&amp;oq=node+hello+world&amp;gs_l=serp.3..0l4j0i22i30l6.307184.309127.0.309241.16.16.0.0.0.0.142.1373.11j3.14.0....0...1.1.64.serp..2.14.1370.yHGtFjiWcUQ">one of the many</a> Node hello world tutorials. Those help to understand the very basics of Node.js.</p>

<p>Running the command <code class="language-plaintext highlighter-rouge">npm install [package name] --save</code> does the trick. It‚Äôll add a dependency to your package.json, but in order to actually use it (for instance in your app.js), you need to assign it to a variable and require it before using it, like so: <code class="language-plaintext highlighter-rouge">var [package name] = require('[package name]');</code></p>

<h4 id="the-stack">The Stack</h4>
<p>We‚Äôll be using the tools below to accomplish our mission. It‚Äôs pretty close to what the cool kids call a MEAN stack (Mongo, Express, Angular, Node) which is on opposite end of the ring as the (perhaps more familiar) LAMP stack (Linux, Apache, MySQL, and PHP  - think Wordpress). The specific tools we‚Äôre using have some really swanky names, check it out:</p>

<ul>
  <li>Node.js - Replaces Apache, as Javascript that runs on a server. The key difference between node and js written for the browser is that Node is all async (and obviously there‚Äôs no DOM to interact with). Which means you need to make sure you‚Äôre using callbacks (more on that later).</li>
  <li><a href="https://www.heroku.com/pricing?c=70130000001xDpdAAE&amp;gclid=CjwKEAjww9O3BRDp1tq0jIP023YSJAB0-j1SyAzHv9ekORTuFBFVVr9N9HbS_CQBkkTmcNndudVJDxoCBTPw_wcB">Heroku</a> - worry free hosting. Seriously, two commands to add Heroku as a remote to your git repository, and you‚Äôre good to go. Also, a reasonable free hosting tier (they charge when you scale things).</li>
  <li><a href="https://github.com/cheeriojs/cheerio">Cheerio</a>, <a href="http://expressjs.com/">Express</a>, <a href="http://phantomjs.org/">PhantomJS</a> - All the Node packages we‚Äôll use. Cheerio is jQuery for Node, express is the most popular web framework for Node, and phantom is what we‚Äôll use to scrape our webpage and return data.</li>
  <li><a href="https://www.mongodb.org/">Mongodb</a> is a NoSQL database. This basically means we can format our data however we want (in this case, basically JSON), and push it up. I used mLab‚Äôs <a href="https://elements.heroku.com/addons/mongolab">MongoDB add-on</a> because it‚Äôs got a free tier and it‚Äôs easy to use.</li>
  <li><a href="http://jade-lang.com/">Jade</a> is an HTML templating language that seems to be the most popular with Node folks, mostly because it pairs so nicely. It‚Äôs white-space aware = üëé, but has a really shallow learning curve = üëç. I tried using handlebars instead, and it turned out to have less documentation, and just added another layer of unnecessary complexity for just starting out.</li>
</ul>

<p>*Side note: I originally followed <a href="https://scotch.io/tutorials/scraping-the-web-with-node-js">this tutorial</a>, which uses a Node package called request instead of phantom. Turns out to be great if you‚Äôre parsing static HTML, but if your page is generated client-side via JS (AJAX or otherwise), you‚Äôll want to make the call using phantom, which will render the page first, then scrape.</p>

<h4 id="whats-happening">What‚Äôs happening</h4>
<p>The app.js sets things up, initiating routes and environments. It sets up the main route to routes/index.js which imports and calls cachedata.js, and uses it‚Äôs returned values to render a Jekyll view for the page.</p>

<p>The cacheData module (modules/cacheData.js) makes a call to the database, pulling down all of the data and checking if the timestamp field is more than 10 min different than the current time. If it is, it calls <code class="language-plaintext highlighter-rouge">getdata</code>, if it isn‚Äôt it returns the data from the intial call back to the index route.</p>

<p>The getData module uses phantom to hit, render and scrape the URL provided. Upon receipt, it‚Äôll convert the data to an array of objects, and return that back to cacheData, which in tern returns the data back to index.js.</p>

<h4 id="get-codin">Get Codin‚Äô</h4>
<p>Since we‚Äôre essentially running a single page app, most of the action will need to be loaded into routes/index.js. To break things out into modules, you can essentially plop your function into a separate file (what I did with cachedata.js and getData.js), then require the module like this:</p>

<p><code class="language-plaintext highlighter-rouge">var getData = require('../modules/getdata.js')</code>. This allows you to then run the function as if it was written in the same file. Be sure to export the function at the end of the file (for an example, check out getData.js).</p>

<h4 id="scrape-responsibly">Scrape responsibly</h4>
<p>This example has minimal footprint, hitting the ESPN servers at most once every 10 minutes, and caching the results. Scraping isn‚Äôt illegal (although can be against the terms and condition of a site), but can be frowned upon especially if it‚Äôs done carelessly, so be sure you‚Äôre cachin‚Äô what you‚Äôre scrapin‚Äô.</p>

<p>Check out the <a href="https://den-madness.herokuapp.com/">live version</a> up on Heroku.</p>
:ET